@{
    ViewData["Title"] = "Báo cáo Doanh thu";
}

<div class="container my-5">
    <h2 class="fw-bold mb-4 text-center">Báo cáo & Thống kê</h2>

    <div class="row mb-4">
        <div class="col-md-4">
            <label for="filterType" class="form-label fw-bold">Xem báo cáo theo:</label>
            <select id="filterType" class="form-select">
                <option value="day">Hôm nay</option>
                <option value="week" selected>7 ngày qua</option>
                <option value="month">Tháng qua (4 tuần)</option>
                <option value="year">Năm qua (12 tháng)</option>
            </select>
        </div>
        <div class="col-md-4 d-flex align-items-end">
            </div>
        <div class="col-md-4 d-flex align-items-end justify-content-end">
            <button id="btnLoadReport" class="btn btn-primary px-5">
                Xem báo cáo
            </button>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col">
            <h4 class="fw-semibold">Biểu đồ doanh thu</h4>
            <div class="card shadow-sm">
                <div class="card-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <h4 class="fw-semibold">Top 10 Sản phẩm bán chạy</h4>
            <div class="card shadow-sm">
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Hình ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Tổng số đã bán</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsTableBody">
                            <tr>
                                <td colspan="4" class="text-center p-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Khai báo biến ---
        const filterSelect = document.getElementById('filterType');
        const loadButton = document.getElementById('btnLoadReport');
        const topProductsTableBody = document.getElementById('topProductsTableBody');
        
        // Biến cho Biểu đồ
        const ctx = document.getElementById('revenueChart').getContext('2d');
        let revenueChartInstance = null; // Biến để lưu trữ biểu đồ

        // --- Hàm 1: Định dạng tiền tệ ---
        function formatCurrency(number) {
            const numericValue = Number(number);
            if (isNaN(numericValue)) return "0 ₫";
            return numericValue.toLocaleString('vi-VN') + ' ₫';
        }

        // --- Hàm 2: Vẽ hoặc Cập nhật Biểu đồ Doanh thu ---
        function renderRevenueChart(chartData) {
            // Nếu biểu đồ đã tồn tại, hủy nó đi để vẽ lại
            if (revenueChartInstance) {
                revenueChartInstance.destroy();
            }

            revenueChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: chartData.labels, 
                    datasets: [{
                        label: 'Doanh thu',
                        data: chartData.data, 
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + ' ₫';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Hàm 3: Hiển thị Bảng Top Sản phẩm ---
        function renderTopProductsTable(products) {
            // Xóa nội dung loading cũ
            topProductsTableBody.innerHTML = ''; 

            if (!products || products.length === 0) {
                topProductsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Không tìm thấy dữ liệu cho bộ lọc này.</td></tr>';
                return;
            }

            let rank = 1;
            products.forEach(product => {
                const row = `
                    <tr>
                        <td class="text-center fw-bold">${rank++}</td>
                        <td>
                            <img src="${product.imageUrl}" alt="${product.productName}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" />
                        </td>
                        <td>
                            <a href="/Store/Details/${product.productId}" class="text-dark text-decoration-none">${product.productName}</a>
                        </td>
                        <td class="text-center fs-5 fw-bold">${product.totalSold}</td>
                    </tr>
                `;
                topProductsTableBody.innerHTML += row;
            });
        }

        // --- Hàm 4: Hàm chính để Tải tất cả Báo cáo (gọi API) ---
        async function loadReports() {
            const filter = filterSelect.value;

            // Hiển thị loading
            topProductsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></td></tr>';
            if (revenueChartInstance) revenueChartInstance.destroy(); // Xóa chart cũ

            try {
                // Gọi API 1: Lấy Doanh thu
                const revenueResponse = await fetch(`@Url.Action("GetRevenueData", "Report")?filterType=${filter}`);
                if (!revenueResponse.ok) throw new Error('Lỗi tải dữ liệu doanh thu');
                const revenueData = await revenueResponse.json();
                
                // Gọi API 2: Lấy Top Sản phẩm
                const productsResponse = await fetch(`@Url.Action("GetTopSellingProducts", "Report")?filterType=${filter}`);
                if (!productsResponse.ok) throw new Error('Lỗi tải dữ liệu sản phẩm');
                const topProductsData = await productsResponse.json();

                // Cập nhật Giao diện
                renderRevenueChart(revenueData);
                renderTopProductsTable(topProductsData);

            } catch (error) {
                console.error("Lỗi khi tải báo cáo:", error);
                topProductsTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-danger">Đã xảy ra lỗi khi tải báo cáo.</td></tr>`;
            }
        }

        // --- Gắn Sự kiện ---
        loadButton.addEventListener('click', loadReports);

        // Tự động tải báo cáo lần đầu (với filter 'week' mặc định)
        loadReports(); 
    });
</script>
}